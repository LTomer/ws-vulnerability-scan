import * as taskLib from 'azure-pipelines-task-lib/task';
import * as toolLib from 'azure-pipelines-tool-lib/tool';
import * as path from 'path';
import * as fs from 'fs';
import util = require("./util.js");

export const TOOL_NAME: string = 'WSAgent'
export const AGENT_FILE_NAME = 'wss-unified-agent.jar';

export async function DownloadAgent(agentUrl: string, days: number) {
    try {
        const version = '0.0.0'; //latest version

        let toolPath: string = toolLib.findLocalTool(TOOL_NAME, version);

        let downloadAgent = isDownloadAgent(toolPath, days);
        if (downloadAgent) {

            taskLib.debug(taskLib.loc("downloadingAgent"));
            let downloadPath: string = await toolLib.downloadTool(agentUrl);

            taskLib.debug(taskLib.loc("cachingAgent"));
            toolLib.cacheFile(downloadPath, AGENT_FILE_NAME, TOOL_NAME, version);

            console.log(taskLib.loc("agentDownloaded"));
        }

        toolPath = toolLib.findLocalTool(TOOL_NAME, version);

        return path.join(toolPath, AGENT_FILE_NAME);
    }
    catch (err) {
        let err_msg = "DownloadAgent failed, error unknown"
        if(err instanceof Error)
            err_msg = err.message
        
        taskLib.setResult(taskLib.TaskResult.Failed, err_msg);
    }
}

function isDownloadAgent(agentPath: string, days: number): boolean {
    try {
        if(!agentPath)
            return true

        const now = new Date()
        let agentFileName: string = path.join(agentPath, AGENT_FILE_NAME);
        const createdDate: Date = fs.statSync(agentFileName).mtime;
        const diffInDays: number = util.daysBetween(createdDate, now)

        taskLib.debug(taskLib.loc("agentDownloadInfo", createdDate, diffInDays));
        return diffInDays > days || diffInDays < 0

    } catch (error) {
        taskLib.debug(`Agent does not exist.`)
        return true;
    }
}
